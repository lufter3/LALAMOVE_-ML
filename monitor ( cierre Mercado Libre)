# ğŸ“š ImportaciÃ³n de librerÃ­as necesarias
from selenium import webdriver                            # Control del navegador
from selenium.webdriver.common.by import By              # LocalizaciÃ³n de elementos
from selenium.webdriver.support.ui import WebDriverWait  # Esperas explÃ­citas
from selenium.webdriver.support import expected_conditions as EC  # Condiciones de espera
from selenium.webdriver.chrome.service import Service     # Servicio del ChromeDriver
from webdriver_manager.chrome import ChromeDriverManager  # Manejo automÃ¡tico del driver
from selenium.webdriver.chrome.options import Options     # Opciones de navegador
import time                                               # Control de tiempo (pausas)
import traceback                                          # Mostrar errores en consola

# ğŸ§® Diccionario acumulador de datos globales
acumulador = {
    "rutas": 0,
    "paquetes": 0,
    "sacas": 0,
    "entregados_u": 0,
    "fallidas_u": 0,
    "entregados_%": [],
    "fallidas_%": []
}

# ğŸ› ï¸ Configura y lanza el navegador con Chrome
def configurar_navegador():
    chrome_options = Options()
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)
    driver.set_window_rect(0, 0, 640, 640)  # TamaÃ±o pequeÃ±o para menor consumo
    wait = WebDriverWait(driver, 60)       # Esperas de hasta 60 segundos
    return driver, wait

# ğŸŒ Abre la URL del sistema
def acceder_al_sistema(driver, url):
    driver.get(url)
    print("ğŸŒ PÃ¡gina cargada:", url)

# ğŸ‘¤ Ingresa el usuario en el campo correspondiente
def ingresar_usuario(wait, usuario):
    user_input = wait.until(EC.presence_of_element_located((By.NAME, "identifier")))
    user_input.send_keys(usuario)
    siguiente_btn = wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, "input[type='submit'], button[type='submit']")))
    siguiente_btn.click()
    print("âœ… Usuario ingresado")

# ğŸ”’ Ingresa la contraseÃ±a y continÃºa
def ingresar_contrasena(wait, contrasena):
    password_input = wait.until(EC.presence_of_element_located((By.NAME, "credentials.passcode")))
    password_input.send_keys(contrasena)
    verificar_btn = wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, "input[type='submit'], button[type='submit']")))
    verificar_btn.click()
    print("âœ… ContraseÃ±a ingresada")

# âœ… Clic en el botÃ³n 'EstÃ¡s viendo'
def clic_boton_estas_viendo(wait):
    estas_viendo_btn = wait.until(EC.element_to_be_clickable((By.XPATH, "//span[contains(text(),'EstÃ¡s viendo')]")))
    estas_viendo_btn.click()
    print("âœ… Clic en botÃ³n 'EstÃ¡s viendo'")

# â³ Espera a que aparezcan los campos de sitio y regiÃ³n
def esperar_campos_busqueda(wait):
    wait.until(EC.presence_of_element_located((By.CLASS_NAME, "appNav_selector__selection")))
    print("â³ Campos de bÃºsqueda listos")

# ğŸ–±ï¸ Pausa para selecciÃ³n manual de regiÃ³n y sitio
def esperar_confirmacion_manual():
    input("ğŸ–±ï¸ Selecciona regiÃ³n y sitio, haz clic en 'Aplicar'. Luego presiona ENTER aquÃ­...")

# ğŸ“Š FunciÃ³n principal que extrae datos de la vista actual
def extraer_datos(driver, wait):
    # Espera a que se cargue el resumen de mÃ©tricas
    wait.until(EC.presence_of_element_located((By.CLASS_NAME, "summary__card-box")))

    # ğŸ“ Extraer nombre del sitio
    site = driver.find_element(By.CLASS_NAME, "appNav_selector__selection").text

    # ğŸ“ˆ Extraer mÃ©tricas numÃ©ricas principales desde tarjetas
    rutas = int(driver.find_element(By.XPATH, "//p[text()='Rutas']/following-sibling::div").text.replace(",", ""))
    paquetes = int(driver.find_element(By.XPATH, "//p[text()='Paquetes']/following-sibling::div").text.replace(",", ""))
    sacas = int(driver.find_element(By.XPATH, "//p[text()='Sacas']/following-sibling::div").text.replace(",", ""))

    # âœ… Extraer entregados desde tooltip usando JavaScript
    entregados_unidades = int(driver.execute_script("""
        let tip = [...document.querySelectorAll('.chart-tooltip-title')].find(e => e.textContent.includes('Entregados'));
        if (tip) {
            let val = tip.closest('.tooltip-content').querySelector('.chart-tooltip-subtitle');
            return val ? val.textContent.replace(/[^\\d]/g, '') : "0";
        }
        return "0";
    """) or "0")

    # ğŸš« Extraer fallidas desde tooltip usando JavaScript
    fallidas_unidades = int(driver.execute_script("""
        let tip = [...document.querySelectorAll('.chart-tooltip-title')].find(e => e.textContent.toLowerCase().includes('fallidas'));
        if (tip) {
            let val = tip.closest('.tooltip-content').querySelector('.chart-tooltip-subtitle');
            return val ? val.textContent.replace(/[^\\d]/g, '') : "0";
        }
        return "0";
    """) or "0")

    # ğŸ“Š Calcular porcentajes considerando paquetes + sacas como total de unidades
    total_unidades = paquetes + sacas
    entregados_porcentaje = round((entregados_unidades / total_unidades) * 100, 2) if total_unidades else 0
    fallidas_porcentaje = round((fallidas_unidades / total_unidades) * 100, 2) if total_unidades else 0

    # ğŸ–¨ï¸ Mostrar los resultados en consola (sitio en negritas)
    print(f"\nğŸ“¦ Datos del sitio: \033[1m{site}\033[0m")
    print(f"ğŸš€ Rutas: {rutas}")
    print(f"ğŸ“¦ Paquetes: {paquetes}")
    print(f"ğŸ’ Sacas: {sacas}")
    print(f"âœ… Entregados (unidades): {entregados_unidades}")
    print(f"âœ… Entregados (%): {entregados_porcentaje} %")
    print(f"ğŸš« Fallidas (unidades): {fallidas_unidades}")
    print(f"ğŸš« Fallidas (%): {fallidas_porcentaje} %")

    # ğŸ’¾ Acumular mÃ©tricas en el diccionario global
    acumulador["rutas"] += rutas
    acumulador["paquetes"] += paquetes
    acumulador["sacas"] += sacas
    acumulador["entregados_u"] += entregados_unidades
    acumulador["fallidas_u"] += fallidas_unidades
    acumulador["entregados_%"].append(entregados_porcentaje)
    acumulador["fallidas_%"].append(fallidas_porcentaje)

# ğŸ“‹ Muestra resumen general acumulado de todos los sitios
def mostrar_resumen_general():
    total_sites = len(acumulador["entregados_%"])
    entregados_avg = round(sum(acumulador["entregados_%"]) / total_sites, 2) if total_sites else 0
    fallidas_avg = round(sum(acumulador["fallidas_%"]) / total_sites, 2) if total_sites else 0

    print("\nğŸ“Š ğŸ”š RESUMEN GENERAL")
    print(f"ğŸš€ Total rutas: {acumulador['rutas']}")
    print(f"ğŸ“¦ Total paquetes: {acumulador['paquetes']}")
    print(f"ğŸ’ Total sacas: {acumulador['sacas']}")
    print(f"âœ… Total entregados (unidades): {acumulador['entregados_u']}")
    print(f"âœ… Promedio entregados (%): {entregados_avg} %")
    print(f"ğŸš« Total fallidas (unidades): {acumulador['fallidas_u']}")
    print(f"ğŸš« Promedio fallidas (%): {fallidas_avg} %")

# ğŸš€ Punto de entrada principal
def main():
    driver, wait = configurar_navegador()
    try:
        # ğŸ” Acceso al sistema
        acceder_al_sistema(driver, "https://envios.adminml.com/logistics/monitoring-distribution")
        ingresar_usuario(wait, "ext_hugodomi")
        ingresar_contrasena(wait, "Empezaron&4193%")

        # ğŸ”„ Loop para revisar varios sitios
        while True:
            clic_boton_estas_viendo(wait)
            esperar_campos_busqueda(wait)
            esperar_confirmacion_manual()
            extraer_datos(driver, wait)

            seguir = input("\nÂ¿Deseas consultar otro site? (Enter = SÃ­ / n = No): ").strip().lower()
            if seguir == 'n':
                break

        # ğŸ“‹ Mostrar resumen acumulado
        mostrar_resumen_general()

    except Exception:
        print("âŒ Se produjo un error:")
        traceback.print_exc()
        driver.save_screenshot("error_debug.png")
    finally:
        print("âœ… El navegador se mantendrÃ¡ abierto para revisiÃ³n manual.")

# ğŸ” Ejecutar el script si se corre directamente
if __name__ == "__main__":
    main()
